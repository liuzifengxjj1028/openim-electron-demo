# 群组创建功能测试说明

## 修改内容总结

### 1. 调整了创建群组的流程顺序
**文件：** `src/pages/common/ChooseModal/index.tsx`

**修改前的流程：**
1. 先填写群名称
2. 上传群头像
3. 选择群成员

**修改后的流程（符合需求）：**
1. **第一步：选择群成员**（移到最上面）
2. **第二步：填写群名称**
3. **第三步：群头像（可选）**

### 2. 添加了创建成功后自动跳转功能
**文件：** `src/pages/common/ChooseModal/index.tsx`（第166-182行）

**功能：**
- 创建群组成功后，自动获取新群组的 groupID
- 使用 `toSpecifiedConversation` 方法自动跳转到新创建的群聊
- 用户无需手动查找和打开新群组

---

## 测试步骤

### 准备工作
1. **确保服务器运行**：OpenIM 服务器应该在 `192.168.210.117` 上运行
2. **确保开发环境启动**：Electron 应用已经启动（在 http://localhost:5173 或 Electron 窗口中）
3. **登录账号**：使用测试账号登录（例如：bud 或 dengteng）
4. **准备测试用户**：确保有至少 2 个好友可以添加到群组

### 测试用例 1：从空聊天页面创建群组

**步骤：**
1. 打开应用，如果当前没有打开任何会话，应该会看到空聊天页面
2. 点击页面中的 **"立即创建"** 或 **"创建群聊"** 按钮
3. **验证顺序**：确认弹出的模态框中，**群成员选择框在最上面**
4. **第一步 - 选择成员**：
   - 在成员列表中勾选至少 2 个好友（例如：dengteng、dengteng2）
   - 确认已选择的成员显示在右侧或顶部
5. **第二步 - 填写群名称**：
   - 在"群名称"输入框中输入：**"测试群组001"**
   - 确认输入框在成员选择框的下方
6. **第三步 - 上传群头像（可选）**：
   - 可以点击"点击修改"上传一张图片
   - 或者跳过此步骤
7. 点击 **"确认"** 按钮
8. **验证结果**：
   - ✅ 模态框自动关闭
   - ✅ 界面自动跳转到新创建的群聊
   - ✅ 聊天窗口顶部显示群名称："测试群组001"
   - ✅ 可以看到群成员数量
   - ✅ 可以立即在群里发送消息

### 测试用例 2：从顶部搜索栏创建群组

**步骤：**
1. 在应用顶部的搜索栏点击搜索图标或输入框
2. 在搜索下拉菜单中选择 **"创建群聊"** 选项
3. 重复测试用例 1 的步骤 3-8
4. **验证结果**：与测试用例 1 相同

### 测试用例 3：从单聊创建群组（拉人进群）

**步骤：**
1. 打开一个已存在的单聊会话（例如：与 dengteng 的聊天）
2. 点击聊天窗口顶部的 **"创建群组"** 图标（launch_group 图标）
3. **验证**：模态框应该自动将当前聊天对象添加到已选成员中
4. 继续选择其他成员（至少再选 1 个）
5. 填写群名称：**"从单聊创建的群"**
6. 点击确认
7. **验证结果**：
   - ✅ 自动跳转到新群聊
   - ✅ 群里包含原来的单聊对象和新选择的成员
   - ✅ 可以立即在群里发送消息

### 测试用例 4：只选择 1 个成员（边界情况）

**步骤：**
1. 打开创建群组模态框
2. **只选择 1 个成员**
3. 填写群名称
4. 点击确认
5. **验证结果**：
   - ✅ 系统应该自动创建单聊而非群聊
   - ✅ 自动跳转到与该成员的单聊窗口

### 测试用例 5：不填写群名称（错误提示）

**步骤：**
1. 打开创建群组模态框
2. 选择 2 个或更多成员
3. **不填写群名称**（留空）
4. 点击确认
5. **验证结果**：
   - ✅ 应该显示错误提示：**"请输入群名称"** 或类似提示
   - ✅ 模态框不应关闭
   - ✅ 用户可以继续填写群名称

### 测试用例 6：不选择成员（错误提示）

**步骤：**
1. 打开创建群组模态框
2. **不选择任何成员**
3. 填写群名称
4. 点击确认
5. **验证结果**：
   - ✅ 应该显示错误提示：**"请至少选择一个成员"** 或类似提示
   - ✅ 模态框不应关闭

---

## 验证重点

### 界面验证
- [ ] 群成员选择框在最上面（第一步）
- [ ] 群名称输入框在中间（第二步）
- [ ] 群头像上传在下面（第三步）
- [ ] 布局美观，没有错位

### 功能验证
- [ ] 可以正常选择多个成员
- [ ] 可以正常填写群名称
- [ ] 可以正常上传群头像
- [ ] 创建成功后自动关闭模态框
- [ ] **创建成功后自动跳转到新群聊**（重点）
- [ ] 新群聊中可以立即发送消息
- [ ] 群成员数量正确显示

### 错误处理验证
- [ ] 不选择成员时有错误提示
- [ ] 不填写群名称时有错误提示
- [ ] 选择 1 个成员时自动创建单聊

---

## 技术实现细节

### 代码修改位置

#### 1. UI 顺序调整
**文件：** `/Users/budlaw/openim-electron-demo/src/pages/common/ChooseModal/index.tsx`

**修改行：** 第243-283行

**关键代码：**
```typescript
{type === "CRATE_GROUP" ? (
  <div className="px-6 pt-4">
    {/* 第一步：选择群成员 - 移到最上面 */}
    <div className="mb-6 flex">
      <div className="min-w-[60px] font-medium">
        {t("placeholder.groupMember")}
      </div>
      <ChooseBox className={clsx("!m-0 !h-[40vh] flex-1")} ref={chooseBoxRef} />
    </div>
    {/* 第二步：填写群名称 */}
    <div className="mb-6 flex items-center">
      <div className="min-w-[60px] font-medium">{t("placeholder.groupName")}</div>
      <Input
        placeholder={t("placeholder.pleaseEnter")}
        maxLength={16}
        spellCheck={false}
        value={groupBaseInfo.groupName}
        onChange={(e) =>
          setGroupBaseInfo((state) => ({ ...state, groupName: e.target.value }))
        }
      />
    </div>
    {/* 群头像（可选） */}
    <div className="mb-6 flex items-center">
      <div className="min-w-[60px] font-medium">
        {t("placeholder.groupAvatar")}
      </div>
      <div className="flex items-center">
        <OIMAvatar src={groupBaseInfo.groupAvatar} isgroup />
        <Upload
          accept="image/*"
          showUploadList={false}
          customRequest={customUpload as any}
        >
          <span className="ml-3 cursor-pointer text-xs text-[var(--primary)]">
            {t("placeholder.clickToModify")}
          </span>
        </Upload>
      </div>
    </div>
  </div>
) : (
```

#### 2. 自动跳转功能
**文件：** `/Users/budlaw/openim-electron-demo/src/pages/common/ChooseModal/index.tsx`

**修改行：** 第158-183行

**关键代码：**
```typescript
case "CRATE_GROUP":
  if (choosedList.length === 1) {
    toSpecifiedConversation({
      sourceID: choosedList[0].userID!,
      sessionType: SessionType.Single,
    });
    break;
  }
  // 创建群组
  const { data: groupInfo } = await IMSDK.createGroup({
    groupInfo: {
      groupType: GroupType.WorkingGroup,
      groupName: groupBaseInfo.groupName,
      faceURL: groupBaseInfo.groupAvatar,
    },
    memberUserIDs: choosedList.map((item) => item.userID!),
    adminUserIDs: [],
  });
  // 创建成功后自动跳转到新群聊
  if (groupInfo?.groupID) {
    toSpecifiedConversation({
      sourceID: groupInfo.groupID,
      sessionType: SessionType.Group,
    });
  }
  break;
```

### 使用的 SDK 方法

1. **IMSDK.createGroup()**
   - 创建群组
   - 返回群组信息（包含 groupID）

2. **toSpecifiedConversation()**
   - 跳转到指定会话
   - 参数：sourceID（群组ID）、sessionType（会话类型）

---

## 测试环境信息

- **OpenIM 服务器地址：** 192.168.210.117
- **开发服务器地址：** http://localhost:5173 或 http://192.168.210.117:5173
- **测试账号：** bud (4132941641)、dengteng (3726747031)、dengteng2 (5707076096)

---

## 预期结果

完成所有测试用例后，应该确认：

1. ✅ **流程顺序正确**：先选人 → 再填名称 → 可选头像
2. ✅ **自动跳转功能正常**：创建成功后立即进入新群聊
3. ✅ **用户体验流畅**：无需手动查找新创建的群组
4. ✅ **错误处理完善**：必填项未填写时有明确提示
5. ✅ **边界情况处理正确**：只选 1 人时创建单聊

---

## 回滚方案

如果测试发现问题需要回滚，可以使用 Git：

```bash
cd /Users/budlaw/openim-electron-demo
git diff src/pages/common/ChooseModal/index.tsx
git checkout src/pages/common/ChooseModal/index.tsx
```

---

## 后续优化建议

1. **添加加载动画**：创建群组时显示 loading 状态
2. **成功提示**：创建成功后显示 Toast 提示
3. **群头像默认值**：如果用户不上传，可以生成一个默认头像
4. **成员限制**：添加群成员数量限制提示
5. **国际化完善**：确保所有文案都支持多语言

---

测试完成后请反馈结果！
